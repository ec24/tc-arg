{% extends 'layout2.njk' %}

{% block content %}

  <script src="js/jquery-3.3.1.min.js"></script>
  <script src="js/jquery-migrate-3.0.1.min.js"></script>
  <script src="js/jquery-ui.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
<div class="site-section" id="scoreboard">
  <div class="container">
    <div class="row">
      <div class="col-md-6 mx-auto text-center mb-3 section-heading">
        <h3>Upsolving Scoreboard 2019</h3>
      </div>
    </div>
    <div id="scoreboard-data">
      <div class="progress">
       <div id="progressbar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" aria-valuenow="0"
       aria-valuemin="0" aria-valuemax="100" style="width:0%">
       </div>
      </div>
    </div>
  </div>
</div>
<script>
var teams = {};
var url_base = "https://vjudge.net/contest/rank/single/";
var contests_id = ["309884", "310047", "310373", "310467"];
var contests_official_id = ["309646", "309921", "310196", "310454"];
var valid_accounts = new Set();
var update_with_contest_data = (validated, idx) => function( data ) {
  $.each( data['participants'], function(id, name) {
    if(validated){
      valid_accounts.add(id);
    }
    if(!(id in teams) && validated){
      teams[id] = {'name': name[1], 'contests': new Array(contests_id.length).fill(0).map((a,b) => new Set())};
    }
  });
  $.each( data['submissions'], function(key, val){
    if(val[2] == 1 && valid_accounts.has(val[0].toString())){
      teams[val[0]]['contests'][idx].add(val[1]);
    }
  });
};
var update_progress_bar = (finished) => {
  var percentage = finished / (2. * contests_id.length) * 100;
  $('#progressbar').css('width', percentage+'%').attr('aria-valuenow', percentage);
};
$.ajaxSetup({async: false});
for(var idx = 0; idx < contests_id.length; idx++){
  (function (){$.getJSON( url_base + contests_official_id[idx], update_with_contest_data(true, idx))})();
  update_progress_bar(idx+1);
}
for(var idx = 0; idx < contests_id.length; idx++){
  (function (){$.getJSON( url_base + contests_id[idx], update_with_contest_data(false, idx))})();
  update_progress_bar(idx+1+contests_id.length);
}
$.ajaxSetup({async: true});
var teams_arr = Object.values(teams);
var array_Sum = arr => arr.reduce((p, q) => p+q, 0);
var map_size = arr => arr.map(l => l.size);
teams_arr.sort( function(a, b){
  var cnt_a = array_Sum(map_size(a['contests']));
  var cnt_b = array_Sum(map_size(b['contests']));
  return cnt_b - cnt_a;
});

var show_upsolving_scoreboard = function(){
  var content = '<div class="table-responsive text-nowrap"><table class="table table-sm"><thead><th>Posici√≥n</th><th>Equipo</th><th>Contest#1</th><th>Contest#2</th><th>Contest#3</th><th>Contest#4</th><th>Total</th></thead><tbody>';
  var last_problem_solved = 0, position = 0;
  if(teams_arr.length > 0){
    last_problem_solved = 1 + array_Sum(map_size(teams_arr[0]['contests']));
  }
  $.each(teams_arr, function(key, val){
    var solved_per_contests = map_size(val['contests']);
    var problems_solved = array_Sum(solved_per_contests);
    if(last_problem_solved > problems_solved){
      last_problem_solved = problems_solved;
      position = key + 1;
    }
    content += '<tr><td>' + position + '</td><td>' + val['name'] + '</td>';
    for(var idx=0; idx<contests_id.length; idx++){
      content += '<td>' + solved_per_contests[idx] + '</td>'
    }
    content += '<td>'+ problems_solved +'</td></tr>';
  });
  content +='</tbody></table></div>';
  $('#scoreboard-data').html(content);
};
show_upsolving_scoreboard();

</script>
{% endblock %}
